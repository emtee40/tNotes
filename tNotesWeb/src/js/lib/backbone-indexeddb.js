!function(){function a(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function b(){return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}function c(a,b,c){this.schema=a,this.ready=b,this.error=null,this.transactions=[],this.db=null,this.nolog=c,this.supportOnUpgradeNeeded=!1;var e=h.last(this.schema.migrations).version;this.nolog||d("opening database "+this.schema.id+" in version #"+e),this.dbRequest=i.open(this.schema.id,e),this.launchMigrationPath=function(b){var c=this.dbRequest.transaction||versionRequest.result,d=h.clone(a.migrations);this.migrate(c,d,b,{success:function(){this.ready()}.bind(this),error:function(){this.error="Database not up to date. "+b+" expected was "+e}.bind(this)})},this.dbRequest.onblocked=function(){this.nolog||d("blocked")},this.dbRequest.onsuccess=function(a){if(this.db=a.target.result,!this.supportOnUpgradeNeeded){var b=parseInt(this.db.version)||0,c=parseInt(e)||0;b===c?this.ready():c>b?this.launchMigrationPath(b):this.error="Database version is greater than current code "+b+" expected was "+c}}.bind(this),this.dbRequest.onerror=function(){this.error="Couldn't not connect to the database"}.bind(this),this.dbRequest.onabort=function(){this.error="Connection to the database aborted"}.bind(this),this.dbRequest.onupgradeneeded=function(a){this.db=a.target.transaction.db,this.supportOnUpgradeNeeded=!0,this.nolog||d("onupgradeneeded = "+a.oldVersion+" => "+a.newVersion),this.launchMigrationPath(a.oldVersion)}.bind(this)}function d(a){"undefined"!=typeof window&&"undefined"!=typeof window.console&&"undefined"!=typeof window.console.log?window.console.log(a):"undefined"!==console.log&&console.log(a)}function e(a,b,d){this.driver=new c(a,this.ready.bind(this),d),this.started=!1,this.stack=[],this.version=h.last(a.migrations).version,this.next=b}function f(a,b,c){if("closeall"==a)return h.each(k,function(a){a.close()}),void(k={});if("undefined"==typeof b.database&&"function"==typeof g.ajaxSync)return g.ajaxSync(a,b,c);var d=b.database;k[d.id]&&k[d.id].version!=h.last(d.migrations).version&&(k[d.id].close(),delete k[d.id]);var f,i=function(){};if("undefined"!=typeof $&&$.Deferred){var j=$.Deferred(),l=j.resolve,m=j.reject;f=j.promise()}else var l=i,m=i;var n=c.success;c.success=function(a){n&&n(a),l(),b.trigger("sync",b,a,c)};var o=c.error;c.error=function(a){o&&o(a),m(),b.trigger("error",b,a,c)};var p=function(){k[d.id].execute([a,b,c])};return k[d.id]?p():k[d.id]=new e(d,p,d.nolog),f}var g,h;"undefined"!=typeof exports?(h=require("underscore"),g=require("backbone")):(h=window._,g=window.Backbone);var i=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB,j=(window.IDBTransaction||window.webkitIDBTransaction||{READ_WRITE:"readwrite"},window.IDBKeyRange||window.webkitIDBKeyRange);window.IDBCursor=window.IDBCursor||window.webkitIDBCursor||window.mozIDBCursor||window.msIDBCursor,c.prototype={_track_transaction:function(a){function b(){var b=this.transactions.indexOf(a);-1!==b&&this.transactions.splice(b)}this.transactions.push(a),a.oncomplete=b.bind(this),a.onabort=b.bind(this),a.onerror=b.bind(this)},migrate:function(a,b,c,e){this.nolog||d("migrate begin version from #"+c);var f=this,g=b.shift();g&&(!c||c<g.version?("undefined"==typeof g.before&&(g.before=function(a){a()}),"undefined"==typeof g.after&&(g.after=function(a){a()}),this.nolog||d("migrate begin before version #"+g.version),g.before(function(){this.nolog||d("migrate done before version #"+g.version);var h=function(){this.nolog||d("migrate begin migrate version #"+g.version),g.migrate(a,function(){this.nolog||d("migrate done migrate version #"+g.version),this.nolog||d("migrate begin after version #"+g.version),g.after(function(){this.nolog||d("migrate done after version #"+g.version),this.nolog||d("Migrated to "+g.version),0==b.length?(this.nolog||d("migrate setting transaction.oncomplete to finish  version #"+g.version),a.oncomplete=function(){f.nolog||d("migrate done transaction.oncomplete version #"+g.version),f.nolog||d("Done migrating"),e.success()}):(this.nolog||d("migrate end from version #"+c+" to "+g.version),f.migrate(a,b,c,e))}.bind(this))}.bind(this))}.bind(this);if(this.supportOnUpgradeNeeded)h();else{this.nolog||d("migrate begin setVersion version #"+g.version);var i=this.db.setVersion(g.version);i.onsuccess=h,i.onerror=e.error}}.bind(this))):(this.nolog||d("Skipping migration "+g.version),this.migrate(a,b,c,e)))},execute:function(a,b,c,e){switch(this.nolog||d("execute : "+b+" on "+a+" for "+c.id),b){case"create":this.create(a,c,e);break;case"read":c.id||c.cid?this.read(a,c,e):this.query(a,c,e);break;case"update":this.update(a,c,e);break;case"delete":c.id||c.cid?this.delete(a,c,e):this.clear(a,c,e)}},create:function(a,c,d){var e,f=this.db.transaction([a],"readwrite"),g=f.objectStore(a),h=c.toJSON();void 0!==h.id||g.autoIncrement||(h.id=b()),f.onerror=function(a){d.error(a)},f.oncomplete=function(){d.success(h)},e=g.keyPath?g.add(h):g.add(h,h.id)},update:function(a,c,d){var e,f=this.db.transaction([a],"readwrite"),g=f.objectStore(a),h=c.toJSON();h.id||(h.id=b()),e=g.keyPath?g.put(h):g.put(h,h.id),e.onerror=function(a){d.error(a)},f.oncomplete=function(){d.success(h)}},read:function(a,b,c){var d=this.db.transaction([a],"readonly");this._track_transaction(d);var e=d.objectStore(a),f=b.toJSON(),g=null;if(f.id)g=e.get(f.id);else if(c.index){var i=e.index(c.index.name);g=i.get(c.index.value)}else{var j=0;h.each(e.indexNames,function(a,b){if(b=e.index(a),"string"==typeof b.keyPath&&1>j)void 0!==f[b.keyPath]&&(g=b.get(f[b.keyPath]),j=1);else if("object"==typeof b.keyPath&&b.keyPath.length>j){var c=!0,d=h.map(b.keyPath,function(a){return c=c&&void 0!==f[a],f[a]});c&&(g=b.get(d),j=b.keyPath.length)}})}g?(g.onsuccess=function(a){a.target.result?c.success(a.target.result):c.error("Not Found")},g.onerror=function(){c.error("Not Found")}):c.error("Not Found")},"delete":function(a,b,c){var d=this.db.transaction([a],"readwrite"),e=d.objectStore(a),f=b.toJSON(),g=e.delete(f.id);d.oncomplete=function(){c.success(null)},g.onerror=function(){c.error("Not Deleted")}},clear:function(a,b,c){var d=this.db.transaction([a],"readwrite"),e=d.objectStore(a),f=e.clear();f.onsuccess=function(){c.success(null)},f.onerror=function(){c.error("Not Cleared")}},query:function(a,b,c){var d=[],e=0,f=0,g=this.db.transaction([a],"readonly"),i=null,k=g.objectStore(a),l=null,m=null,n=null,o=null;c.conditions?h.each(k.indexNames,function(a){i||(l=k.index(a),c.conditions[l.keyPath]instanceof Array?(m=c.conditions[l.keyPath][0]>c.conditions[l.keyPath][1]?c.conditions[l.keyPath][1]:c.conditions[l.keyPath][0],n=c.conditions[l.keyPath][0]>c.conditions[l.keyPath][1]?c.conditions[l.keyPath][0]:c.conditions[l.keyPath][1],o=j.bound(m,n,!0,!0),i=c.conditions[l.keyPath][0]>c.conditions[l.keyPath][1]?l.openCursor(o,window.IDBCursor.PREV||"prev"):l.openCursor(o,window.IDBCursor.NEXT||"next")):void 0!=c.conditions[l.keyPath]&&(o=j.only(c.conditions[l.keyPath]),i=l.openCursor(o)))}):c.range?(m=c.range[0]>c.range[1]?c.range[1]:c.range[0],n=c.range[0]>c.range[1]?c.range[0]:c.range[1],o=j.bound(m,n),i=c.range[0]>c.range[1]?k.openCursor(o,window.IDBCursor.PREV||"prev"):k.openCursor(o,window.IDBCursor.NEXT||"next")):i=k.openCursor(),"undefined"!=typeof i&&i?(i.onerror=function(a){c.error("readCursor error",a)},i.onsuccess=function(a){var g=a.target.result;if(g)if(c.limit&&f>=c.limit)o&&c.conditions[l.keyPath]?g.continue(c.conditions[l.keyPath][1]+1):g.continue();else if(c.offset&&c.offset>e)e++,g.continue();else{if(c.addIndividually)b.add(g.value);else if(c.clear){var h=k.delete(g.value.id);h.onsuccess=function(){d.push(g.value)},h.onerror=function(){d.push(g.value)}}else d.push(g.value);f++,g.continue()}else c.addIndividually||c.clear?b.trigger("reset"):c.success(d)}):c.error("No Cursor")},close:function(){this.db&&this.db.close()}},e.prototype={ready:function(){this.started=!0,h.each(this.stack,function(a){this.execute(a)}.bind(this)),this.stack=[],this.next()},execute:function(a){this.started?this.driver.execute(a[2].storeName||a[1].storeName,a[0],a[1],a[2]):this.stack.push(a)},close:function(){this.driver.close()}};var k={};"undefined"==typeof exports?(g.ajaxSync=g.sync,g.sync=f):(exports.sync=f,exports.debugLog=d)}();