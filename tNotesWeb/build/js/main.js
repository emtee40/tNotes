define("setting",[],function(){var e=Backbone.Model.extend({localStorage:new Backbone.LocalStorage("setting"),defaults:{id:0,folderId:1,noteId:1,style:"default",contentViewerStyle:"default"},initialize:function(){this.bind("change",function(){this.save()})}}),t=new e;return localStorage.setting?t.fetch():t.save(),t}),define("Database",[],function(){var e=function(e,t,n,r){return{id:e,description:t,storeName:r,migrations:[{version:n,migrate:function(e,t){var n=e.db.createObjectStore(r);t()}}]}};return e}),define("noteDb",["Database"],function(e){var t=new e("notes","笔记数据库",1,"notes");return t}),define("NoteModel",["setting","noteDb"],function(e,t){var n=Backbone.Model.extend({database:t,storeName:t.storeName,defaults:{id:0,folderId:0,title:"",content:"",createTime:0,modifiedTime:0},initialize:function(t){if(!t.id){var n=e.get("noteId"),r=_.now();this.set({id:-n,createTime:r,modifiedTime:r}),e.set("noteId",n+1)}_.bindAll(this,"save"),this.bind("change",function(){this.save()})}});return n}),define("noteCollection",["NoteModel","noteDb"],function(e,t){var n=Backbone.Collection.extend({model:e,database:t,storeName:t.storeName}),r=new n;return r.fetch(),r}),define("util",[],function(){var e={};return e.getSelectionHtml=function(){var e=window.getSelection();if(e.rangeCount){var t=document.createElement("div");for(var n=0,r=e.rangeCount;n<r;++n)t.appendChild(e.getRangeAt(n).cloneContents());html=t.innerHTML}return html},e.getSelectionPos=function(){var e=window.getSelection(),t=e.getRangeAt(0),n=t.getBoundingClientRect(),r=n.left+(n.right-n.left)/2,i=n.top;return{x:r,y:i}},e.getSelectionRange=function(){var e=window.getSelection(),t;return e.rangeCount&&(t=e.getRangeAt(0)),t},e.htmlToText=function(e){return e.replace(/<br>/g,"\n").replace(/&nbsp;/g," ")},e.textToHtml=function(e){return e.replace(/\n/g,"<br>").replace(/\s/g,"&nbsp;")},e.timestampToTime=function(e){var t=new Date(e);return t.getFullYear()+"-"+(t.getMonth()+1)+"-"+t.getDate()+" "+t.getHours()+":"+t.getMinutes()+":"+t.getSeconds()},e}),define("contentViewer",["setting","noteCollection","util"],function(e,t,n){var r=Backbone.View.extend({el:$("#content"),$noteTitle:$("#note-title"),$noteContent:$("#note-content"),$noteFooter:$("#note-footer"),$saveBtn:$("#save-btn"),$editBtn:$("#edit-btn"),$saveQuitBtn:$("#save-quit-btn"),$deleteBtn:$("#delete-btn"),$exportBtn:$("#export-btn"),$expandBtn:$("#expand-btn"),$imgPreview:$("#img-preview"),$editTool:$("#edit-tool"),markdownConverter:new Showdown.converter,defaultTitle:"tNotes",defaultContent:"![intro](img/intro.jpg)\n\n- *离线存储*：断开网络也能使用\n- *远程同步*：将本地数据备份到远程服务器\n- *Markdown支持*：支持基本的Markdown语法，多种显示样式\n\n> Developed By *腾讯广研创新班邮箱组*",size:-1,selectedText:"",range:null,isEditing:!1,currentNote:null,noteCollection:t,events:{"click .change-style":"changeStyleClicked","click #img-preview":"closeImgPreview","click #note-content img":"showImgPreview","click #print-btn":"print","click #edit-btn:not(.disabled)":"editNote","click #delete-note-confirm-btn":"closeDeleteNoteModal","keyup #note-content":"updateOnTyping"},initialize:function(){var t=e.get("contentViewerStyle");this.changeStyle(t),this.initEditor(),this.reset(),setTimeout($.proxy(function(){this.setNote(7)},this),2e3)},changeStyle:function(t){this.$noteContent.attr("class","panel-body "+t),e.set("contentViewerStyle",t)},changeStyleClicked:function(e){var t=$(e.target);style=t.attr("data-style"),this.changeStyle(style)},closeDeleteNoteModal:function(){$("#deleteNoteModal").modal("hide")},closeImgPreview:function(){this.$imgPreview.fadeOut("fast")},deleteNote:function(){this.currentNote.destroy(),this.reset()},disableEdit:function(){this.$noteTitle.removeAttr("contentEditable"),this.$noteContent.removeAttr("contentEditable"),this.isEditing=!1,this.$saveQuitBtn.addClass("hidden"),this.$editBtn.removeClass("hidden")},editNote:function(){var e=this.currentNote;this.isEditing=!0,this.enalbleEdit(),this.$noteTitle.html(e.get("title")),this.$noteContent.html(n.textToHtml(e.get("content")))},enalbleEdit:function(){this.$noteTitle.attr("contentEditable","true"),this.$noteContent.attr("contentEditable","true"),this.$saveQuitBtn.removeClass("hidden"),this.$editBtn.addClass("hidden"),this.setBtnState({save:!1,edit:!1,"delete":!1,"export":!1})},initEditor:function(){this.$noteContent.on("keypress",function(e){if(e.which===13){e.preventDefault();if(window.getSelection){var t=window.getSelection(),n=t.getRangeAt(0),r=document.createElement("br");n.deleteContents(),n.insertNode(r),n.setStartAfter(r),n.setEndAfter(r),t.removeAllRanges(),t.addRange(n)}}}).on("mouseup",$.proxy(function(){if(this.isEditing===!0){this.selectedText=n.getSelectionHtml();if($.trim(this.selectedText)!==""){var e=n.getSelectionPos();this.$editTool.css("left",e.x-78+"px").css("top",e.y-70+"px").fadeIn("fast"),this.range=n.getSelectionRange()}}},this)).on("mousedown blur",$.proxy(function(){this.$editTool.fadeOut("fast")},this)),$("#bold-btn").on("click",$.proxy(function(){var e="**"+this.selectedText+"**";this.replaceSelectionText(e)},this)),$("#italic-btn").on("click",$.proxy(function(){var e="*"+this.selectedText+"*";this.replaceSelectionText(e)},this)),$("#insert-link-confirm-btn").on("click",$.proxy(function(){var e="["+this.selectedText+"]"+"("+$("#link").val()+")";$("#is-img-link").is(":checked")===!0&&(e="!"+e),this.replaceSelectionText(e)},this)),$(".scroll").on("click",function(){$.smoothScroll({scrollTarget:$(this).attr("data-target"),speed:300,easing:"linear"})})},print:function(){window.print()},replaceSelectionText:function(e){this.range.deleteContents(),this.range.insertNode(document.createTextNode(e))},reset:function(){this.currentNote=null,this.setTitleAndContent({title:this.defaultTitle,content:this.markdownConverter.makeHtml(this.defaultContent)}),this.setFooter("版本号：V1.0，更新于2014年3月24日"),this.setBtnState({save:!1,edit:!1,"delete":!1,"export":!1})},saveNote:function(){this.currentNote.set({title:this.$noteTitle.text(),content:n.htmlToText(this.$noteContent.html()),modifiedTime:_.now()}),this.setBtnState({save:!1})},setBtnState:function(e){function t(e,t,n){t===!1?(e.addClass("disabled"),n===!0&&e.removeAttr("data-toggle")):t===!0&&(e.removeClass("disabled"),n===!0&&e.attr("data-toggle","modal"))}typeof e["save"]!="undefined"&&t(this.$saveBtn,e.save,!1),typeof e["edit"]!="undefined"&&t(this.$editBtn,e.edit,!1),typeof e["delete"]!="undefined"&&t(this.$deleteBtn,e["delete"],!0),typeof e["export"]!="undefined"&&t(this.$exportBtn,e["export"],!1)},setFooter:function(e){this.$noteFooter.html(e)},setNote:function(e){this.currentNote=this.noteCollection.get(e),this.showNote()},setTitleAndContent:function(e){this.$noteTitle.html(e.title),this.$noteContent.html(e.content)},showImgPreview:function(e){var t=$(e.target);this.$imgPreview.find("img").attr("src",t.attr("src")),this.$imgPreview.fadeIn("fast")},showNote:function(){var e=this.currentNote;this.disableEdit(),this.setTitleAndContent({title:e.get("title"),content:this.markdownConverter.makeHtml(_.unescape(e.get("content")))}),this.setFooter("修改时间："+n.timestampToTime(e.get("modifiedTime"))),this.$exportBtn.attr("download",e.get("title")+".md").attr("href",URL.createObjectURL(new Blob([e.get("content").replace(/\n/g,"\r\n")],{type:"text/plain"}))),this.setBtnState({save:!1,edit:!0,"delete":!0,"export":!0}),this.$noteContent.find("pre").addClass("prettyprint linenums"),prettyPrint()},toggleSize:function(){return this.size===-1?(this.$expandBtn.html('<span class="glyphicon glyphicon-resize-small"></span> 收缩'),this.size=1,this.$el.toggleClass("fill"),!0):(this.$expandBtn.html('<span class="glyphicon glyphicon-resize-full"></span> 展开'),this.size=-1,this.$el.toggleClass("fill"),!1)},updateOnTyping:function(){if(this.isEditing===!0){var e=this.$noteContent.text().length;this.setFooter("字数："+e),this.setBtnState({save:!0})}},validate:function(){return $.trim(this.$noteTitle.text())===""?"标题不能为空":!0}}),i=new r;return i}),define("hint",[],function(){var e=Backbone.View.extend({el:$("#hint"),$hintContent:$("#hint-content"),$hintTitle:$("#hint-title"),autoDismiss:!0,events:{"click .close":"close"},initialize:function(){this.setType("info").setTitle("提示").setContent("提示信息")},close:function(){return this.$el.slideUp("fast"),this},setAutoDismiss:function(e){return this.autoDismiss=e,this},setContent:function(e){return this.$hintContent.html(e),this},setTitle:function(e){return this.$hintTitle.html(e),this},setType:function(e){return this.$el.attr("class","alert alert-dismissable display-none alert-"+e),this},show:function(){return this.$el.slideDown("fast"),this.autoDismiss&&setTimeout($.proxy(this.close,this),3e3),this}}),t=new e;return t}),define("contentViewerRouter",["contentViewer","hint"],function(e,t){var n=Backbone.Router.extend({routes:{deleteNote:"deleteNote",saveNote:"saveNote",saveAndQuitEditing:"saveAndQuitEditing",toggleContentViewerSize:"toggleSize"},clearNav:function(){this.navigate("",{trigger:!1})},deleteNote:function(){e.deleteNote(),this.clearNav()},saveNote:function(){var n=e.validate();if(n===!0)return e.saveNote(),this.clearNav(),!0;t.setType("warning").setTitle("警告").setContent(n).show(),this.clearNav()},saveAndQuitEditing:function(){var t=this.saveNote();t===!0&&(e.disableEdit(),e.showNote())},toggleSize:function(){e.toggleSize(),this.clearNav()}}),r=new n;return r}),define("folderListRouter",[],function(){var e=Backbone.Router.extend({routes:{}}),t=new e;return t}),define("noteListRouter",[],function(){var e=Backbone.Router.extend({routes:{}}),t=new e;return t}),define("navbarRouter",[],function(){var e=Backbone.Router.extend({routes:{}}),t=new e;return t}),define("utils/test",[],function(){}),require.config({paths:{Database:"db/Database",folderDb:"db/folderDb",noteDb:"db/noteDb",FolderModel:"model/FolderModel",NoteModel:"model/NoteModel",setting:"model/setting",folderCollection:"collection/folderCollection",noteCollection:"collection/noteCollection",contentViewer:"view/contentViewer",folderList:"view/folderList",noteList:"view/noteList",navbar:"view/navbar",hint:"view/hint",contentViewerRouter:"router/contentViewerRouter",folderListRouter:"router/folderListRouter",noteListRouter:"router/noteListRouter",navbarRouter:"router/navbarRouter",util:"utils/util"}}),require(["contentViewerRouter","folderListRouter","noteListRouter","navbarRouter","utils/test"],function(e,t,n,r,i){Backbone.history.start(),$("body").on("click","a.disabled",function(e){e.preventDefault()})}),define("main",function(){});