define("setting",[],function(){var e=Backbone.Model.extend({url:"http://tnotes.wicp.net:8080/",syncFinishedHandler:null,beginTime:_.now(),isSyncing:!1,localStorage:new Backbone.LocalStorage("setting"),defaults:{id:0,folderId:1,noteId:1,isLogined:!1,username:"",password:"",session:"",style:"bs-black",bg:"",contentViewerStyle:"default",autoSyncInterval:5,folderSyncDeleted:[],folderSyncModified:[],folderSyncCreated:[],noteSyncDeleted:[],noteSyncModified:[],noteSyncCreated:[]},initialize:function(){this.bind("change",function(){console.log("Setting Saved!"),this.save()})},clear:function(){this.set({isLogined:!1,username:"",password:"",session:"",folderSyncDeleted:[],folderSyncModified:[],folderSyncCreated:[],noteSyncDeleted:[],noteSyncModified:[],noteSyncCreated:[]})},synchronize:function(e){this.trigger("synchronize",e)}}),t=new e;return localStorage.setting?t.fetch():t.save(),t}),define("Database",[],function(){var e=function(e,t,n,r){return{id:e,description:t,storeName:r,migrations:[{version:n,migrate:function(e,t){var n=e.db.createObjectStore(r);t()}}]}};return e}),define("noteDb",["Database"],function(e){var t=new e("notes","笔记数据库",1,"notes");return t}),define("NoteModel",["setting","noteDb"],function(e,t){var n=Backbone.Model.extend({database:t,storeName:t.storeName,defaults:{id:0,folderId:0,title:"",content:"",createTime:0,modifiedTime:0},initialize:function(t){if(!t.id){var n=e.get("noteId"),r=_.now();this.set({id:-n,createTime:r,modifiedTime:r}),e.set("noteId",n+1)}}});return n}),define("htmlToText",[],function(){function e(e,t){function n(e,t){var n;return t.substr(0,1)=="#"?t.substr(1,1)=="x"?n=parseInt(t.substr(2),16):n=parseInt(t.substr(1),10):n=r[t],n===undefined||n===NaN?"&"+t+";":String.fromCharCode(n)}var r={nbsp:160,iexcl:161,cent:162,pound:163,curren:164,yen:165,brvbar:166,sect:167,uml:168,copy:169,ordf:170,laquo:171,not:172,shy:173,reg:174,macr:175,deg:176,plusmn:177,sup2:178,sup3:179,acute:180,micro:181,para:182,middot:183,cedil:184,sup1:185,ordm:186,raquo:187,frac14:188,frac12:189,frac34:190,iquest:191,Agrave:192,Aacute:193,Acirc:194,Atilde:195,Auml:196,Aring:197,AElig:198,Ccedil:199,Egrave:200,Eacute:201,Ecirc:202,Euml:203,Igrave:204,Iacute:205,Icirc:206,Iuml:207,ETH:208,Ntilde:209,Ograve:210,Oacute:211,Ocirc:212,Otilde:213,Ouml:214,times:215,Oslash:216,Ugrave:217,Uacute:218,Ucirc:219,Uuml:220,Yacute:221,THORN:222,szlig:223,agrave:224,aacute:225,acirc:226,atilde:227,auml:228,aring:229,aelig:230,ccedil:231,egrave:232,eacute:233,ecirc:234,euml:235,igrave:236,iacute:237,icirc:238,iuml:239,eth:240,ntilde:241,ograve:242,oacute:243,ocirc:244,otilde:245,ouml:246,divide:247,oslash:248,ugrave:249,uacute:250,ucirc:251,uuml:252,yacute:253,thorn:254,yuml:255,quot:34,amp:38,lt:60,gt:62,OElig:338,oelig:339,Scaron:352,scaron:353,Yuml:376,circ:710,tilde:732,ensp:8194,emsp:8195,thinsp:8201,zwnj:8204,zwj:8205,lrm:8206,rlm:8207,ndash:8211,mdash:8212,lsquo:8216,rsquo:8217,sbquo:8218,ldquo:8220,rdquo:8221,bdquo:8222,dagger:8224,Dagger:8225,permil:8240,lsaquo:8249,rsaquo:8250,euro:8364},s=e;t&&t.preprocessing&&(s=t.preprocessing(s)),s=s.replace(/(?:\n|\r\n|\r)/ig," ").replace(/<\s*script[^>]*>[\s\S]*?<\/script>/mig,"").replace(/<\s*style[^>]*>[\s\S]*?<\/style>/mig,"").replace(/<!--.*?-->/mig,"").replace(/<!DOCTYPE.*?>/ig,""),t&&t.tagreplacement&&(s=t.tagreplacement(s));var o=["p","h[1-6]","dl","dt","dd","ol","ul","dir","address","blockquote","center","div","hr","pre","form","textarea","table"],u=["li","del","ins","fieldset","legend","tr","th","caption","thead","tbody","tfoot"];for(i=0;i<o.length;i++){var a=RegExp("</?\\s*"+o[i]+"[^>]*>","ig");s=s.replace(a,"\n\n")}for(i=0;i<u.length;i++){var a=RegExp("<\\s*"+u[i]+"[^>]*>","ig");s=s.replace(a,"\n")}return s=s.replace(/<\s*br[^>]*\/?\s*>/ig,"\n"),s=s.replace(/(<([^>]+)>)/ig,"").replace(/([^\n\S]+)\n/g,"\n").replace(/([^\n\S]+)$/,"").replace(/\n{2,}/g,"\n\n").replace(/^\n+/,"").replace(/\n+$/,"").replace(/&([^;]+);/g,n),t&&t.postprocessing&&(s=t.postprocessing(s)),s}return e}),define("util",["htmlToText"],function(e){var t={};return t.singleArrayClone=function(e){var t=[],n,r;for(n=0,r=e.length;n<r;n++)t[n]=e[n];return t},t.getSelectionHtml=function(){var e=window.getSelection();if(e.rangeCount){var t=document.createElement("div");for(var n=0,r=e.rangeCount;n<r;++n)t.appendChild(e.getRangeAt(n).cloneContents());html=t.innerHTML}return html},t.getSelectionPos=function(){var e=window.getSelection(),t=e.getRangeAt(0),n=t.getBoundingClientRect(),r=n.left+(n.right-n.left)/2,i=n.top;return{x:r,y:i}},t.getSelectionRange=function(){var e=window.getSelection(),t;return e.rangeCount&&(t=e.getRangeAt(0)),t},t.htmlToText=function(t){return e(t)},t.removeArrayValue=function(e,t){var n=e.indexOf(t);return n>=0&&e.splice(n,1),e},t.replaceArrayValue=function(e,t,n){var r=e.indexOf(t),i=!1;while(r>=0)i=!0,e[r]=n,r=e.indexOf(t);return i},t.textToHtml=function(e){return e.replace(/\n/g,"<br>").replace(/\s/g,"&nbsp;")},t.timestampToTime=function(e){var t=new Date(e);return t.getFullYear()+"-"+(t.getMonth()+1)+"-"+t.getDate()+" "+t.getHours()+":"+t.getMinutes()+":"+t.getSeconds()},t}),define("syncHelper",["setting"],function(e){var t={};return t.isLogined=function(){return e.get("isLogined")},t.isOnline=function(){return navigator.onLine?!0:!1},t.isAllSync=function(){return e.get("folderSyncDeleted").length!==0?!1:e.get("folderSyncModified").length!==0?!1:e.get("folderSyncCreated").length!==0?!1:e.get("noteSyncDeleted").length!==0?!1:e.get("noteSyncModified").length!==0?!1:e.get("noteSyncCreated").length!==0?!1:!0},t}),define("noteCollection",["NoteModel","noteDb","util","setting","syncHelper"],function(e,t,n,r,i){var s=Backbone.Collection.extend({model:e,database:t,storeName:t.storeName,visibility:!0,current:null,currentNotes:[],currentNotesIds:[],addSyncCreated:function(e){var t=r.get("noteSyncCreated");t.push(e),r.save(),r.synchronize()},removeSyncCreated:function(e){var t=r.get("noteSyncCreated");n.removeArrayValue(t,e),r.save()},addSyncDeleted:function(e){var t=r.get("noteSyncDeleted");t.push(e),r.save(),r.synchronize()},removeSyncDeleted:function(e){var t=r.get("noteSyncDeleted");n.removeArrayValue(t,e),r.save()},addSyncModified:function(e){var t=r.get("noteSyncModified");n.removeArrayValue(t,e),t.push(e),r.save(),r.synchronize()},removeSyncModified:function(e){var t=r.get("noteSyncModified");n.removeArrayValue(t,e),r.save()},addNoteToCurrentNotes:function(e){this.currentNotesIds.push(e),this.fetchNotes()},clear:function(){this.each(function(e){e.destroy()});var e=indexedDB.open("notes");e.onsuccess=function(){var t=e.result,n=t.transaction(["notes"],"readwrite"),r=n.objectStore("notes");r.clear()},this.setCurrentNotes([]),this.setCurrent(null)},clearCurrentNotes:function(){this.currentNotesIds=[],this.fetchNotes()},deleteById:function(e){this.get(e).destroy()},deleteByIds:function(e){var t,n;for(t=0,n=e.length;t<n;t++)this.deleteById(e[t])},fetchNotes:function(){var e,t,n=this.currentNotesIds;this.currentNotes=[];for(e=0,t=n.length;e<t;e++){var r=this.get(n[e]);this.currentNotes[e]=r.toJSON()}this.trigger("currentNotesChanged")},fetchRemote:function(e){if(e<0)return;i.isAllSync()===!0?this.trigger("fetchRemote",e):(r.syncFinishedHandler=$.proxy(function(){this.fetchRemote(e)},this),r.synchronize())},fetchRemoteSingle:function(e){if(e<0)return;i.isAllSync()===!0?this.trigger("fetchRemoteSingle",e):(r.syncFinishedHandler=$.proxy(function(){this.fetchRemoteSingle(e)},this),r.synchronize())},getCurrent:function(){return this.current},getCurrentNotes:function(){return this.currentNotes},getCurrentNotesIds:function(){return this.currentNotesIds},getVisibility:function(){return this.visibility},newNote:function(e){var t=this.create({folderId:e,title:"标题",content:""});return this.setCurrent(t.get("id")),this.trigger("newNote"),t},removeNoteFromCurrentNotes:function(e){this.currentNotesIds=n.removeArrayValue(this.currentNotesIds,e),this.fetchNotes()},setCurrent:function(e,t){e===null?this.current=null:this.current=this.get(e),t===!0&&this.fetchRemoteSingle(e),this.trigger("currentChanged")},setCurrentNotes:function(e){this.currentNotesIds=n.singleArrayClone(e),this.fetchNotes()},setVisibility:function(e){this.visibility=e,this.trigger("visibilityChanged")},updateFolderId:function(e,t){var n=this.where({folderId:e}),r,i;for(r=0,i=n.length;r<i;r++){var s=n[r];s.set("folderId",t),s.save()}},updateId:function(e,t){var r=this.get(e),i=_.clone(r.attributes),s=r.get("folderId");i.id=t,this.create(i),this.current&&this.current.get("id")===e&&(this.current=this.get(t));var o=this.currentNotesIds;return n.replaceArrayValue(o,e,t)&&this.setCurrentNotes(o),r.destroy(),s}}),o=new s;return o.fetch(),o}),define("folderDb",["Database"],function(e){var t=new e("folders","文件夹数据库",1,"folders");return t}),define("FolderModel",["setting","folderDb","util"],function(e,t,n){var r=Backbone.Model.extend({database:t,storeName:t.storeName,defaults:{id:0,name:"",notes:[],createTime:0,modifiedTime:0},initialize:function(t){if(!t.id){var n=e.get("folderId"),r=_.now();this.set({id:-n,createTime:r,modifiedTime:r}),e.set("folderId",n+1)}},insertNoteId:function(e){var t=this.get("notes");n.removeArrayValue(t,e),t.push(e),this.set({notes:t}),this.save()},removeNoteId:function(e){var t=this.get("notes");t=n.removeArrayValue(t,e),this.set({notes:t,modifiedTimestamp:_.now()}),this.save()}});return r}),define("folderCollection",["FolderModel","folderDb","setting","util","syncHelper"],function(e,t,n,r,i){var s=Backbone.Collection.extend({model:e,database:t,storeName:t.storeName,visibility:!0,current:null,comparator:function(e){return-e.get("modifiedTime")},addSyncCreated:function(e){var t=n.get("folderSyncCreated");t.push(e),n.save(),n.synchronize()},removeSyncCreated:function(e){var t=n.get("folderSyncCreated");r.removeArrayValue(t,e),n.save()},addSyncDeleted:function(e){var t=n.get("folderSyncDeleted");t.push(e),n.save(),n.synchronize()},addSyncModified:function(e){var t=n.get("folderSyncModified");t=r.removeArrayValue(t,e),t.push(e),n.set("folderSyncModified",t),n.synchronize()},removeSyncModified:function(e){var t=n.get("folderSyncModified");r.removeArrayValue(t,e),n.save()},clear:function(){var e=indexedDB.open("folders"),t=this;e.onsuccess=function(){var n=e.result,r=n.transaction(["folders"],"readwrite"),i=r.objectStore("folders"),s=i.clear();s.onsuccess=function(){t.reset(),t.setCurrent(null)}}},deleteCurrent:function(){this.current.destroy(),this.current=null},deleteExceptThese:function(e){var t=this.toJSON(),n=[],r,i,s;for(r=0,i=t.length;r<i;r++){var o=t[r].id;e.indexOf(o)<0&&o>0&&(s=this.get(o),s.destroy())}},fetchRemote:function(){i.isAllSync()===!0?this.trigger("fetchRemote"):(n.syncFinishedHandler=$.proxy(this.fetchRemote,this),n.synchronize())},getCurrent:function(){return this.current},getVisibility:function(){return this.visibility},renameCurrent:function(e){this.current.set({name:e,modifiedTime:_.now()})},setCurrent:function(e){e===null?this.current=null:this.current=this.get(e),this.trigger("currentChanged")},setVisibility:function(e){this.visibility=e,this.trigger("visibilityChanged")},updateId:function(e,t){var n=this.get(e),r=_.clone(n.attributes);r.id=t,this.create(r),this.current&&this.current.get("id")===e&&this.setCurrent(t),n.destroy()}}),o=new s;return o.fetch(),o}),define("contentViewer",["setting","noteCollection","folderCollection","util"],function(e,t,n,r){var i=Backbone.View.extend({el:$("#content"),$noteTitle:$("#note-title"),$noteContent:$("#note-content"),$noteFooter:$("#note-footer"),$saveBtn:$("#save-btn"),$editBtn:$("#edit-btn"),$saveQuitBtn:$("#save-quit-btn"),$deleteBtn:$("#delete-btn"),$exportBtn:$("#export-btn"),$expandBtn:$("#expand-btn"),$imgPreview:$("#img-preview"),$editTool:$("#edit-tool"),markdownConverter:new Showdown.converter,defaultTitle:"tNotes",defaultContent:"![intro](img/intro.jpg)\n\n- *离线存储*：断开网络也能使用\n- *远程同步*：将本地数据备份到远程服务器\n- *Markdown支持*：支持基本的Markdown语法，多种显示样式\n\n> Developed By *腾讯广研创新班邮箱组*",size:-1,selectedText:"",range:null,isEditing:!1,collection:t,folderCollection:n,events:{"click .change-style":"changeStyleClicked","click #img-preview":"closeImgPreview","click #note-content img":"showImgPreview","click #save-btn":"saveNote","click #save-quit-btn":"saveAndQuitEditing","click #expand-btn":"toggleSize","click #print-btn":"print","click #delete-note-confirm-btn":"deleteNote","click #edit-btn:not(.disabled)":"editNote","keyup #note-content":"updateOnTyping","keyup #note-title":"updateOnTyping"},initialize:function(){var t=e.get("contentViewerStyle");this.changeStyle(t),this.initEditor(),this.reset(),_.bindAll(this,"editNote","showNote"),this.collection.bind("newNote",this.editNote),this.collection.bind("currentChanged",this.showNote)},changeStyle:function(t){this.$noteContent.attr("class","panel-body "+t),e.set("contentViewerStyle",t)},changeStyleClicked:function(e){var t=$(e.target);style=t.attr("data-style"),this.changeStyle(style)},clear:function(){this.$noteTitle.html(""),this.$noteContent.html("")},closeImgPreview:function(){this.$imgPreview.fadeOut("fast")},deleteNote:function(){var e=this.collection.getCurrent(),t=e.get("folderId"),n=this.folderCollection.get(t),r=e.get("id");this.collection.removeNoteFromCurrentNotes(r),r<0?this.collection.removeSyncCreated(r):(this.collection.addSyncDeleted(r),this.collection.removeSyncModified(r)),n.removeNoteId(e.get("id")),n.save(),e.destroy(),this.reset()},disableEdit:function(){this.$noteTitle.removeAttr("contentEditable"),this.$noteContent.removeAttr("contentEditable"),this.isEditing=!1,this.$saveQuitBtn.addClass("hidden"),this.$editBtn.removeClass("hidden")},editNote:function(){var e=this.collection.getCurrent();this.isEditing=!0,this.enalbleEdit(),this.$noteTitle.html(e.get("title")),this.$noteContent.html(r.textToHtml(e.get("content")))},enalbleEdit:function(){this.$noteTitle.attr("contentEditable","true"),this.$noteContent.attr("contentEditable","true"),this.$saveQuitBtn.removeClass("hidden"),this.$editBtn.addClass("hidden"),this.setBtnState({save:!1,edit:!1,"delete":!1,"export":!1})},initEditor:function(){this.$noteContent.on("keypress",function(e){if(e.which===13){e.preventDefault();if(window.getSelection){var t=window.getSelection(),n=t.getRangeAt(0),r=document.createElement("br");n.deleteContents(),n.insertNode(r),n.setStartAfter(r),n.setEndAfter(r),t.removeAllRanges(),t.addRange(n)}}}).on("mouseup",$.proxy(function(){if(this.isEditing===!0){this.selectedText=r.getSelectionHtml();if($.trim(this.selectedText)!==""){var e=r.getSelectionPos();this.$editTool.css("left",e.x-78+"px").css("top",e.y-70+"px").fadeIn("fast"),this.range=r.getSelectionRange()}}},this)).on("mousedown blur",$.proxy(function(){this.$editTool.fadeOut("fast")},this)),$("#bold-btn").on("click",$.proxy(function(){var e="**"+this.selectedText+"**";this.replaceSelectionText(e)},this)),$("#italic-btn").on("click",$.proxy(function(){var e="*"+this.selectedText+"*";this.replaceSelectionText(e)},this)),$("#insert-link-confirm-btn").on("click",$.proxy(function(){var e="["+this.selectedText+"]"+"("+$("#link").val()+")";$("#is-img-link").is(":checked")===!0&&(e="!"+e),this.replaceSelectionText(e)},this)),$(".scroll").on("click",function(){$.smoothScroll({scrollTarget:$(this).attr("data-target"),speed:300,easing:"linear"})})},print:function(){window.print()},replaceSelectionText:function(e){this.range.deleteContents(),this.range.insertNode(document.createTextNode(e))},reset:function(){this.currentNote=null,this.setTitleAndContent({title:this.defaultTitle,content:this.markdownConverter.makeHtml(this.defaultContent)}),this.setFooter("版本号：V1.0，更新于2014年3月24日"),this.setBtnState({save:!1,edit:!1,"delete":!1,"export":!1})},saveAndQuitEditing:function(){this.saveNote(),s.disableEdit(),s.showNote()},saveNote:function(){var e=this.collection.getCurrent();e.set({title:this.$noteTitle.text(),content:r.htmlToText(this.$noteContent.html()),modifiedTime:_.now()}),e.save();var t=e.get("id");t>0&&this.collection.addSyncModified(t);var n=this.folderCollection.get(e.get("folderId"));this.collection.setCurrentNotes(n.get("notes")),this.setBtnState({save:!1})},setBtnState:function(e){function t(e,t,n){t===!1?(e.addClass("disabled"),n===!0&&e.removeAttr("data-toggle")):t===!0&&(e.removeClass("disabled"),n===!0&&e.attr("data-toggle","modal"))}typeof e["save"]!="undefined"&&t(this.$saveBtn,e.save,!1),typeof e["edit"]!="undefined"&&t(this.$editBtn,e.edit,!1),typeof e["delete"]!="undefined"&&t(this.$deleteBtn,e["delete"],!0),typeof e["export"]!="undefined"&&t(this.$exportBtn,e["export"],!1)},setFooter:function(e){this.$noteFooter.html(e)},setNote:function(e){this.currentNote=this.collection.get(e),this.showNote()},setTitleAndContent:function(e){this.$noteTitle.html(e.title),this.$noteContent.html(e.content)},showImgPreview:function(e){var t=$(e.target);this.$imgPreview.find("img").attr("src",t.attr("src")),this.$imgPreview.fadeIn("fast")},showNote:function(){var e=this.collection.getCurrent();if(e===null){this.reset();return}this.disableEdit(),this.setTitleAndContent({title:e.get("title"),content:this.markdownConverter.makeHtml(_.unescape(e.get("content")))}),this.setFooter("修改时间："+r.timestampToTime(e.get("modifiedTime"))),this.$exportBtn.attr("download",e.get("title")+".md").attr("href",URL.createObjectURL(new Blob([e.get("content").replace(/\n/g,"\r\n")],{type:"text/plain"}))),this.setBtnState({save:!1,edit:!0,"delete":!0,"export":!0}),this.$noteContent.find("pre").addClass("prettyprint linenums"),prettyPrint()},toggleSize:function(){return this.size===-1?(this.$expandBtn.html('<span class="glyphicon glyphicon-resize-small"></span> 收缩'),this.size=1,this.collection.setVisibility(!1),this.folderCollection.setVisibility(!1),this.$el.toggleClass("fill"),!0):(this.$expandBtn.html('<span class="glyphicon glyphicon-resize-full"></span> 展开'),this.size=-1,this.collection.setVisibility(!0),this.folderCollection.setVisibility(!0),this.$el.toggleClass("fill"),!1)},updateOnTyping:function(){if(this.isEditing===!0){var e=this.$noteContent.text().length;this.setFooter("字数："+e),this.setBtnState({save:!0})}},validate:function(){return $.trim(this.$noteTitle.text())===""?"标题不能为空":!0}}),s=new i;return s}),define("hint",[],function(){var e=Backbone.View.extend({el:$("#hint"),$hintContent:$("#hint-content"),$hintTitle:$("#hint-title"),autoDismiss:!0,events:{"click .close":"close"},initialize:function(){this.setType("info").setTitle("提示").setContent("提示信息")},close:function(){return this.$el.slideUp("fast"),this},setAutoDismiss:function(e){return this.autoDismiss=e,this},setContent:function(e){return this.$hintContent.html(e),this},setTitle:function(e){return this.$hintTitle.html(e),this},setType:function(e){return this.$el.attr("class","alert alert-dismissable display-none alert-"+e),this},show:function(){return this.$el.slideDown("fast"),this.autoDismiss&&setTimeout($.proxy(this.close,this),3e3),this}}),t=new e;return t}),define("contentViewerRouter",["contentViewer","hint"],function(e,t){var n=Backbone.Router.extend({routes:{deleteNote:"deleteNote",saveNote:"saveNote",saveAndQuitEditing:"saveAndQuitEditing",toggleContentViewerSize:"toggleSize"},clearNav:function(){this.navigate("",{trigger:!1})},deleteNote:function(){e.deleteNote(),this.clearNav()},saveNote:function(){var n=e.validate();if(n===!0)return e.saveNote(),this.clearNav(),!0;t.setType("warning").setTitle("警告").setContent(n).show(),this.clearNav()},saveAndQuitEditing:function(){var t=this.saveNote();t===!0&&(e.disableEdit(),e.showNote())},toggleSize:function(){e.toggleSize(),this.clearNav()}}),r=new n;return r}),define("folderList",["folderCollection","noteCollection"],function(e,t){var n=Backbone.View.extend({el:$("#folder"),$folderList:$("#folder-list"),$newFolderName:$("#new-folder-name"),$renameFolderBtn:$("#rename-folder-btn"),$deleteFolderBtn:$("#delete-folder-btn"),template:_.template($("#folder-template").html()),collection:e,noteCollection:t,events:{"click #new-folder-confirm-btn":"newFolder","click #delete-folder-confirm-btn":"deleteFolder","click #rename-folder-confirm-btn":"renameFolder"},initialize:function(){_.bindAll(this,"render","changeVisibility"),this.collection.bind("add",this.render),this.collection.bind("change",this.render),this.collection.bind("remove",this.render),this.collection.bind("currentChanged",this.render),this.collection.bind("visibilityChanged",this.changeVisibility)},render:function(){this.$folderList.html(this.template({folders:this.collection.toJSON()})),this.collection.current?(this.toggleBtn(!0),this.$folderList.find('[data-id="'+this.collection.current.get("id")+'"]').addClass("active")):this.toggleBtn(!1)},changeVisibility:function(){var e=this.collection.getVisibility();e===!0?this.$el.fadeIn("fast"):this.$el.fadeOut("fast")},deleteFolder:function(){var e=this.collection.getCurrent(),t=e.get("notes"),n=e.get("id"),r,i;this.collection.setCurrent(null),n<0?this.collection.removeSyncCreated(n):(this.collection.addSyncDeleted(n),this.collection.removeSyncModified(n)),this.noteCollection.deleteByIds(t),this.noteCollection.clearCurrentNotes(),this.noteCollection.setCurrent(null);for(r=0,i=t.length;r<i;r++){var s=t[r];this.noteCollection.removeSyncCreated(s),this.noteCollection.removeSyncModified(s),this.noteCollection.removeSyncDeleted(s)}e.destroy()},newFolder:function(){var e=this.collection.create({name:this.$newFolderName.val(),notes:[]});this.collection.addSyncCreated(e.get("id"))},renameFolder:function(){var e=$("#rename-folder-name").val(),t=this.collection.getCurrent(),n=t.get("id");this.collection.renameCurrent(e),n>0&&this.collection.addSyncModified(n)},selectFolder:function(e){this.collection.setCurrent(e);var t=this.collection.getCurrent();if(t===undefined)return;this.noteCollection.setCurrentNotes(t.get("notes")),this.noteCollection.fetchRemote(t.get("id"))},toggleBtn:function(e){e===!0?(this.$deleteFolderBtn.removeClass("disabled").attr("data-toggle","modal"),this.$renameFolderBtn.removeClass("disabled").attr("data-toggle","modal")):(this.$deleteFolderBtn.addClass("disabled").removeAttr("data-toggle"),this.$renameFolderBtn.addClass("disabled").removeAttr("data-toggle"))}}),r=new n;return r}),define("folderListRouter",["folderList","setting"],function(e,t){var n=Backbone.Router.extend({routes:{"folder/:id":"selectFolder"},selectFolder:function(n){_.now()-t.beginTime>500?e.selectFolder(n):setTimeout(function(){e.selectFolder(n)},500)}}),r=new n;return r}),define("noteList",["noteCollection","folderCollection","hint"],function(e,t,n){var r=Backbone.View.extend({el:$("#note"),$noteList:$("#note-list"),newNoteProcessing:!1,template:_.template($("#note-template").html()),collection:e,folderCollection:t,events:{"click #new-note-btn":"newNote"},initialize:function(){_.bindAll(this,"render","changeVisibility"),this.collection.bind("currentNotesChanged",this.render),this.collection.bind("currentChanged",this.render),this.collection.bind("visibilityChanged",this.changeVisibility)},render:function(){this.$noteList.html(this.template({notes:this.collection.getCurrentNotes()}));var e=this.collection.getCurrent();e&&this.$noteList.find('[data-id="'+e.get("id")+'"]').addClass("active")},changeVisibility:function(){var e=this.collection.getVisibility();e===!0?this.$el.fadeIn("fast"):this.$el.fadeOut("fast")},newNote:function(){var e=this.folderCollection.getCurrent();if(e===null)n.setType("warning").setTitle("请选择一个文件夹").setContent("你必须选择一个文件夹后方可创建新笔记").show();else{if(this.newNoteProcessing===!0)return;this.newNoteProcessing=!0,setTimeout($.proxy(function(){this.newNoteProcessing=!1},this),500);var t=this.collection.newNote(e.get("id"));e.insertNoteId(t.get("id")),e.save(),this.collection.addNoteToCurrentNotes(t.get("id")),this.collection.addSyncCreated(t.get("id"))}},selectNote:function(e){this.collection.setCurrent(e,!0)}}),i=new r;return i}),define("noteListRouter",["noteList","setting"],function(e,t){var n=Backbone.Router.extend({routes:{"note/:id":"selectNote"},selectNote:function(n){_.now()-t.beginTime>500?e.selectNote(n):setTimeout(function(){e.selectNote(n)},500)}}),r=new n;return r}),define("login",["setting","hint"],function(e,t){function r(r,i,s,o){$.post(n,'{"user": "'+r+'","pass": "'+i+'"}',function(n){var u="",a="",f="";n.status==="success"?(e.set("isLogined",!0),e.set("username",r),e.set("password",i),e.set("session",n.session),u="success",a="尊敬的"+r+":",f="您现在已处于登录状态，接下来将自动为您进行同步",e.synchronize(),typeof o=="function"&&o()):n.status==="incorrect_password"?(u="warning",a="警告",f="密码填写错误"):n.exception&&(u="danger",a="出错",f="抱歉！服务器端暂时无法处理您的请求，请稍后再进行尝试"),s===!0&&t.setType(u).setTitle(a).setContent(f).show()},"json").error(function(){s===!0&&t.setType("danger").setTitle("出错").setContent("发出请求出错，可能是服务器发生故障或者你没有连接到网络").show()})}var n=e.url+"signin.cgi";return r}),define("signup",["setting","hint"],function(e,t){function r(e,r){$.post(n,'{"user": "'+e+'","pass": "'+r+'"}',function(n){var r="",i="",s="";n.status==="success"?(r="success",i="尊敬的"+e+":",s="您已经成功注册了帐号，请点击同步按钮登录帐号"):n.status==="used_username"?(r="warning",i="警告",s="抱歉，该用户名已被注册过，请重新填写一个新的用户名"):n.exception&&(r="danger",i="出错",s="抱歉！服务器端暂时无法处理您的请求，请稍后再进行尝试"),t.setType(r).setTitle(i).setContent(s).show()},"json").error(function(){hit.setType("danger").setTitle("出错").setContent("发生请求出错，请确保你已经连接了网络").show()})}var n=e.url+"signup.cgi";return r}),define("navbar",["setting","syncHelper","login","signup","folderCollection","noteCollection"],function(e,t,n,r,i,s){var o=Backbone.View.extend({el:$("#navbar"),$body:$("body"),$settingBtn:$("#setting-btn"),collection:null,events:{"click .change-bg":"changeBgClicked","click .change-style":"changeStyleClicked","click #set-custom-bg-btn":"setCustomBg","click #sync-btn":"synchronize","click #login-btn":"login","click #logout-confirm-btn":"logout","click #signup-btn":"signup","click #sync-interval-confirm-btn":"setAutoSyncInterval"},initialize:function(){var t=e.get("bg");t!==""&&this.changeBg(t);var n=e.get("style");this.changeStyle(n),e.get("isLogined")===!0&&(this.toggleSettingBtn(!0),$("#auto-sync-val").val(e.get("autoSyncInterval")),setTimeout($.proxy(function(){this.autoSync()},this),200))},autoSync:function(){console.log("自动同步"),this.synchronize(),e.get("isLogined")===!0&&setTimeout($.proxy(function(){this.autoSync()},this),e.get("autoSyncInterval")*6e4)},changeBg:function(t){this.$body.css("background-image","url("+t+")"),e.synchronize()},changeBgClicked:function(t){var n=$(t.target),r=n.attr("data-src");this.changeBg(r),e.set("bg",r)},changeStyle:function(e){this.$body.attr("class",e)},changeStyleClicked:function(t){var n=$(t.target),r=n.attr("data-style");this.changeStyle(r),e.set("style",r)},login:function(){var e=$("#input-username").val(),t=$("#input-password").val();n(e,t,!0,$.proxy(function(){this.toggleSettingBtn(!0),this.autoSync(),i.fetchRemote()},this))},logout:function(){e.clear(),this.toggleSettingBtn(!1),s.clear(),i.clear(),location.hash=""},setCustomBg:function(){var t=$("#bg-url").val();this.changeBg(t),e.set("bg",t)},toggleSettingBtn:function(e){e===!0?this.$settingBtn.removeClass("hidden"):this.$settingBtn.addClass("hidden")},setAutoSyncInterval:function(){e.set("autoSyncInterval",Number($("#auto-sync-val").val()))},signup:function(){var e=$("#input-username").val(),t=$("#input-password").val();r(e,t)},synchronize:function(){t.isLogined()===!1?$("#loginModal").modal("show"):(e.syncFinishedHandler=function(){i.fetchRemote()},e.synchronize(!0))}}),u=new o;return u}),define("navbarRouter",["navbar"],function(e){var t=Backbone.Router.extend({routes:{}}),n=new t;return n}),define("utils/test",["util","setting"],function(e,t){}),define("sync",["syncHelper","setting","noteCollection","folderCollection","util","login","hint"],function(e,t,n,r,i,s,o){function v(){return t.get("isSyncing")===!0?!1:(t.set("isSyncing",!0),!0)}function m(e){t.set("isSyncing",!1),d===!0?o.setType("info").setTitle("提示").setContent(e).show():console.log(e)}function g(t){if(v()===!1)return;t===!0?d=!0:d=!1,e.isLogined()===!1?m("未登录，无法同步"):e.isOnline()===!1?m("无法连接网络"):e.isAllSync()===!0?(x(),m("没有数据需要同步")):y()}function y(){var e=t.get("folderSyncCreated");if(e.length===0)setTimeout(function(){b()},0);else{var n=e[0],i=r.get(n);$.post(u,'{"session":"'+t.get("session")+'", "name":'+JSON.stringify(i.get("name"))+"}",function(r){var i=r.exception;i===undefined||i==="Node Handling Failure"?(e.shift(),t.save(),setTimeout(function(){T(n,r.id),y()},0)):i==="Session Failure"?(m("Session失效"),s(t.get("username"),t.get("password"),g)):m(p.serverException)}).error(function(){m(p.noConnection)})}}function b(){var e=t.get("folderSyncDeleted");if(e.length===0)setTimeout(function(){w()},0);else{var n=e[0];$.post(a,'{"session":"'+t.get("session")+'", "id":'+n+"}",function(n){var r=n.exception;r===undefined||r==="Node Handling Failure"?(e.shift(),t.save(),setTimeout(function(){b()},0)):m(p.serverException)}).error(function(){m(p.noConnection)})}}function w(){var e=t.get("folderSyncModified");if(e.length===0)setTimeout(function(){E()},0);else{var n=e[0],i=r.get(n);$.post(f,'{"session":"'+t.get("session")+'", "id":'+n+', "name":'+JSON.stringify(i.get("name"))+"}",function(n){var r=n.exception;r===undefined||r==="Node Handling Failure"?(e.shift(),t.save(),setTimeout(function(){w()},0)):m(p.serverException)}).error(function(){m(p.noConnection)})}}function E(){var e=t.get("noteSyncCreated");if(e.length===0)setTimeout(function(){S()},0);else{var r=e[0],i=n.get(r);$.post(l,'{"session":"'+t.get("session")+'","name":'+JSON.stringify(i.get("title"))+',"content":'+JSON.stringify(i.get("content"))+',"location":'+i.get("folderId")+"}",function(n){var i=n.exception;i===undefined||i==="Article Handling Failure"?(e.shift(),t.save(),setTimeout(function(){N(r,n.id),E()},0)):m(p.serverException)}).error(function(){m(p.noConnection)})}}function S(){var e=t.get("noteSyncDeleted");if(e.length===0)setTimeout(function(){x()},0);else{var n=e[0];$.post(c,'{"session":"'+t.get("session")+'", "id":'+n+"}",function(n){var r=n.exception;r===undefined||r==="Article Handling Failure"?(e.shift(),t.save(),setTimeout(function(){S()},0)):m(p.serverException)}).error(function(){m(p.noConnection)})}}function x(){var e=t.get("noteSyncModified");if(e.length===0){m("同步成功！");var r=t.syncFinishedHandler;r!==null&&setTimeout(function(){r()},0)}else{var i=e[0],s=n.get(i);$.post(h,'{"session":"'+t.get("session")+'", "id":'+i+', "name":'+JSON.stringify(s.get("title"))+', "content":'+JSON.stringify(s.get("content"))+"}",function(n){var r=n.exception;r===undefined||r==="Article Handling Failure"?(e.shift(),t.save(),setTimeout(function(){x()},0)):m(p.serverException)}).error(function(){m(p.noConnection)})}}function T(e,t){r.updateId(e,t),n.updateFolderId(e,t)}function N(e,t){var i=n.updateId(e,t),s=r.get(i);s.removeNoteId(e),s.insertNoteId(t)}var u=t.url+"createnode.cgi",a=t.url+"deletenode.cgi",f=t.url+"changenode.cgi",l=t.url+"createarticle.cgi",c=t.url+"deletearticle.cgi",h=t.url+"changearticle.cgi",p={serverException:"抱歉！服务器端暂时无法处理您的请求，请稍后再进行尝试",noConnection:"发出请求出错，可能是服务器发生故障或者你没有连接到网络"},d=!1;return t.bind("synchronize",g),g}),define("fetch",["setting","folderCollection","noteCollection"],function(e,t,n){function u(){$.post(r,'{"session":"'+e.get("session")+'"}',function(e){if(e.exception)console.log(o.serverException),console.log(e.exception);else{var n=e.node,r,i,s=[];if(n===null)return;for(r=0,i=n.length;r<i;r++){var u=n[r];s.push(u.id);var a=t.get(u.id);a===undefined?t.create({id:u.id,name:u.name,notes:[]}):(a.set("name",u.name),a.save())}t.deleteExceptThese(s)}}).error(function(){console.log(o.noConnection)})}function a(r){$.post(i,'{"session":"'+e.get("session")+'","id":'+r+"}",function(e){if(e.exception)console.log(o.serverException),console.log(e.exception);else{var i=e.article,s,u,a=t.get(r);if(i===null)return;var f=[];for(s=0,u=i.length;s<u;s++){var l=i[s];f.push(l.id),n.create({id:l.id,title:l.name,folderId:r,modifiedTime:l.stamp}),a.insertNoteId(l.id)}a.save();var c=n.getCurrentNotesIds(),l;for(s=0,u=c.length;s<u;s++){var h=c[s];f.indexOf(h)<0&&h>0&&(l=n.get(h),a=t.get(l.get("folderId")),a.removeNoteId(h),a.save(),l.destroy())}a=t.getCurrent();if(a.get("id")!==r)return;n.setCurrentNotes(a.get("notes"))}}).error(function(){console.log(o.noConnection)})}function f(t){$.post(s,'{"session":"'+e.get("session")+'","id":['+t+"]}",function(e){if(e.exception)console.log(o.serverException),console.log(e.exception);else{var r=e.article[0],i=n.getCurrent();if(i.get("id")!==r.id)return;i.set({title:r.name,content:r.content,modifiedTime:r.stamp}),i.save(),n.setCurrent(t,!1)}}).error(function(){console.log(o.noConnection)})}var r=e.url+"fetchnodes.cgi",i=e.url+"fetchbriefs.cgi",s=e.url+"fetcharticles.cgi",o={serverException:"抱歉！服务器端暂时无法处理您的请求，请稍后再进行尝试",noConnection:"发出请求出错，可能是服务器发生故障或者你没有连接到网络"};t.bind("fetchRemote",u),n.bind("fetchRemote",a),n.bind("fetchRemoteSingle",f);return}),require.config({paths:{Database:"db/Database",folderDb:"db/folderDb",noteDb:"db/noteDb",FolderModel:"model/FolderModel",NoteModel:"model/NoteModel",setting:"model/setting",folderCollection:"collection/folderCollection",noteCollection:"collection/noteCollection",contentViewer:"view/contentViewer",folderList:"view/folderList",noteList:"view/noteList",navbar:"view/navbar",hint:"view/hint",contentViewerRouter:"router/contentViewerRouter",folderListRouter:"router/folderListRouter",noteListRouter:"router/noteListRouter",navbarRouter:"router/navbarRouter",util:"utils/util",htmlToText:"utils/htmlToText",login:"utils/login",signup:"utils/signup",sync:"utils/sync",fetch:"utils/fetch",syncHelper:"utils/syncHelper"}}),require(["contentViewerRouter","folderListRouter","noteListRouter","navbarRouter","utils/test","sync","fetch","login","setting","folderCollection"],function(e,t,n,r,i,s,o,u,a,f){Backbone.history.start(),$("body").on("click","a.disabled",function(e){e.preventDefault()}),a.get("isLogined")===!0&&u(a.get("username"),a.get("password"),!1,function(){_.now()-a.beginTime>500?f.fetchRemote():setTimeout(function(){f.fetchRemote()},500)})}),define("main",function(){});